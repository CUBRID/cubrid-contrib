-- File Open : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml


-- Filename : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
-- Query    : select
-- Query Id : findOpenResortOpinListTot

		SELECT '' AS cur_keep_org_cd		    , '°è' AS dept_abbr_nm		    , 0 AS close_flag		    , COUNT(1) as total		    , SUM(CASE WHEN a.current_open_div_cd = '3' THEN 1 ELSE 0 END) as non_open_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '3' AND resort_prog_state_cd IN ('2','3','4','5','6','7') THEN 1 ELSE 0 END) as non_open_choice_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '3' AND resort_prog_state_cd IN ('6','7') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '3' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '0' THEN 1 ELSE 0 END)) as non_open_choice_excute_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '3' AND resort_prog_state_cd IN ('2','3','4') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '3' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '1' THEN 1 ELSE 0 END)) as non_open_choice_unexcute_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '2' THEN 1 ELSE 0 END) as part_open_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '2' AND resort_prog_state_cd IN ('2','3','4','5','6','7') THEN 1 ELSE 0 END) as part_open_choice_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '2' AND resort_prog_state_cd IN ('6','7') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '0' THEN 1 ELSE 0 END)) as part_open_choice_excute_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '2' AND resort_prog_state_cd IN ('2','3','4') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '1' THEN 1 ELSE 0 END)) as part_open_choice_unexcute_cnt			, SUM(CASE WHEN a.current_open_div_cd = '1' THEN 1 ELSE 0 END) as all_open_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '1' AND resort_prog_state_cd IN ('2','3','4','5','6','7') THEN 1 ELSE 0 END) as all_open_choice_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '1' AND resort_prog_state_cd IN ('6','7') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '0' THEN 1 ELSE 0 END)) as all_open_choice_excute_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '1' AND resort_prog_state_cd IN ('2','3','4') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '1' THEN 1 ELSE 0 END)) as all_open_choice_unexcute_cnt		FROM (		    SELECT f.cur_keep_org_cd		    	, d.resort_prog_state_cd		    	, d.current_open_div_cd		    	, d.discu_trgt_flag		    	, '1' as record_center_id		    	, '1' as resort_yyyy		    	, '1' as resort_case		    FROM tb_rdopenresortopin d, tb_rdfolder f		    WHERE d.record_center_id = f.record_center_id		    AND d.folder_id = f.folder_id		    AND d.record_center_id = '1'		    AND d.resort_yyyy = '1'		    AND d.resort_case = '1'		) a	;


-- Filename : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
-- Query    : select
-- Query Id : findOpenResortOpinList

		SELECT a.cur_keep_org_cd		    , (SELECT dept_abbr_nm FROM tb_stdept WHERE record_center_id = a.record_center_id AND org_cd = a.cur_keep_org_cd) dept_abbr_nm		    , (SELECT close_flag FROM tb_stdept WHERE record_center_id = a.record_center_id AND org_cd = a.cur_keep_org_cd) close_flag		    , COUNT(1) as total		    , SUM(CASE WHEN a.current_open_div_cd = '3' THEN 1 ELSE 0 END) as non_open_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '3' AND resort_prog_state_cd IN ('2','3','4','5','6','7') THEN 1 ELSE 0 END) as non_open_choice_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '3' AND resort_prog_state_cd IN ('6','7') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '3' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '0' THEN 1 ELSE 0 END)) as non_open_choice_excute_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '3' AND resort_prog_state_cd IN ('2','3','4') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '3' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '1' THEN 1 ELSE 0 END)) as non_open_choice_unexcute_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '2' THEN 1 ELSE 0 END) as part_open_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '2' AND resort_prog_state_cd IN ('2','3','4','5','6','7') THEN 1 ELSE 0 END) as part_open_choice_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '2' AND resort_prog_state_cd IN ('6','7') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '0' THEN 1 ELSE 0 END)) as part_open_choice_excute_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '2' AND resort_prog_state_cd IN ('2','3','4') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '1' THEN 1 ELSE 0 END)) as part_open_choice_unexcute_cnt			, SUM(CASE WHEN a.current_open_div_cd = '1' THEN 1 ELSE 0 END) as all_open_cnt		    , SUM(CASE WHEN a.current_open_div_cd = '1' AND resort_prog_state_cd IN ('2','3','4','5','6','7') THEN 1 ELSE 0 END) as all_open_choice_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '1' AND resort_prog_state_cd IN ('6','7') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '0' THEN 1 ELSE 0 END)) as all_open_choice_excute_cnt		    , (SUM(CASE WHEN a.current_open_div_cd = '1' AND resort_prog_state_cd IN ('2','3','4') THEN 1 ELSE 0 END) + SUM(CASE WHEN a.current_open_div_cd = '2' AND a.resort_prog_state_cd = '5' AND a.discu_trgt_flag = '1' THEN 1 ELSE 0 END)) as all_open_choice_unexcute_cnt		FROM (		    SELECT f.cur_keep_org_cd		    	, d.resort_prog_state_cd		    	, d.current_open_div_cd		    	, d.discu_trgt_flag		    	, '1' as record_center_id		    	, '1' as resort_yyyy		    	, '1' as resort_case		    FROM tb_rdopenresortopin d, tb_rdfolder f		    WHERE d.record_center_id = f.record_center_id		    AND d.folder_id = f.folder_id		    AND d.record_center_id = '1'		    AND d.resort_yyyy = '1'		    AND d.resort_case = '1'		) a		GROUP BY a.cur_keep_org_cd, a.record_center_id	;


-- Filename : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
-- Query    : select
-- Query Id : countTransfTrgtOpenResortList

				SELECT  COUNT(*)		FROM    tb_dfrecvtransflist D, tb_rdfolder F, tb_rdrecord R        WHERE   D.record_center_id = '1'        AND     D.record_center_id = F.record_center_id        AND     F.record_center_id = R.record_center_id        AND     D.folder_id = F.folder_id        AND     F.folder_id = R.folder_id        AND     F.transf_state_cd = '3'        AND     D.transf_div_cd <> 5        AND     D.transf_yyyy = '1'        AND 	R.record_id NOT IN (        	SELECT O.record_id             FROM tb_rdopenresortopin O            WHERE O.record_center_id = '1'            AND O.resort_yyyy = '1'            AND O.resort_case = '2'         )	;


-- Filename : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
-- Query    : select
-- Query Id : findTransfTrgtOpenResortList

		SELECT r.record_center_id			, r.folder_id			, r.record_id			, '1' as resort_yyyy			, (SELECT NVL(MAX(RESORT_SEQ), 0) + 1 FROM tb_rdopenresortopin WHERE record_center_id = r.record_center_id AND record_id = r.record_id) as resort_seq			, '2' as resort_case			, '1' as resort_prog_state_cd			, r.org_cd			, r.open_div_cd as current_open_div_cd			, f.clss_id		FROM tb_rdfolder f, tb_rdrecord r		WHERE r.record_center_id = '1'		AND	f.folder_id = r.folder_id		AND f.expt_transf_yyyy = '1'		AND f.transf_state_cd = '3'		AND r.open_div_cd != '1';


-- Filename : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
-- Query    : insert
-- Query Id : createTransfTrgtOpenResortList

		INSERT INTO tb_rdopenresortopin (record_center_id			, folder_id			, record_id			, resort_yyyy			, resort_seq			, resort_case			, resort_prog_state_cd			, org_cd			, current_open_div_cd			, clss_id			, discu_trgt_flag		) SELECT  r.record_center_id			, r.folder_id			, r.record_id			, '1' as resort_yyyy			, (SELECT NVL(MAX(RESORT_SEQ), 0) + 1 FROM tb_rdopenresortopin WHERE record_center_id = r.record_center_id AND record_id = r.record_id) as resort_seq			, '2' as resort_case			, '1' as resort_prog_state_cd			, r.org_cd			, r.open_div_cd			, f.clss_id			, '0'        FROM tb_dfrecvtransflist D, tb_rdfolder F, tb_rdrecord R        WHERE D.record_center_id = '1'        AND D.record_center_id = F.record_center_id        AND F.record_center_id = R.record_center_id        AND D.folder_id = F.folder_id        AND F.folder_id = R.folder_id        AND F.transf_state_cd = '3'        AND D.transf_div_cd <> 5        AND D.transf_yyyy = '1'     	AND D.transf_grp_sno = ( SELECT MAX(TRANSF_GRP_SNO) FROM tb_dfrecvtransflist                                 WHERE record_center_id = '1'                                 AND   transf_yyyy = '1'                                 AND   folder_id =  D.folder_id                               )                AND (R.last_open_resort_yyyy IS NULL OR TO_CHAR(SYSDATE, 'YYYY')-NVL(R.last_open_resort_yyyy, 0) > 5)        AND R.record_id NOT IN (        	SELECT O.record_id             FROM tb_rdopenresortopin O            WHERE O.record_center_id = '1'            AND O.resort_yyyy = '1'            AND O.resort_case = '2'         )	;


-- Filename : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
-- Query    : delete
-- Query Id : deleteResortData

		DELETE FROM TB_RDOPENRESORTOPIN		WHERE record_center_id = '1'		AND	RESORT_YYYY = '1'		AND	RESORT_CASE = '1'		AND RESORT_PROG_STATE_CD = '1'		AND	SCHEDULE_SEQ = '1';


-- File Close : C:\eclipse\workspace\SqlMapXMLParser\rmsCubrid\rms\default\rms\eval\openresortopin\OpenResortOpinTrgtState.xml
